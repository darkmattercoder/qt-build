language: python
python:
  - 3.6
services:
- docker
branches:
  only:
  - deploy
before_install:
  - pip install docker
  - pip install pyaml
  - pip install fire
env:
  global:
    - DOCKER_USERNAME=darkmattercoder
    - secure: Bz/3Zzw3D7lhK61YiHHsniQAlQgDJ4XtpTg/QBjapM/I0vuBnNMKFW8s7TFyjqBhnKcAq41YHG+KIjnnTS5pD8VgDM5U//PW/rJJp/0Q+bQmL5ZG0HOzERNYUWCUtpBdrgqwmTxKvmsuQzzNruR4ERtraCuKCK0U3bAtpcNPAhwNbdfSd03SZaEc+aqEKfxr+gxZo8m/dH8qJMVSttd9B/PMKupmddcxbUHJa04nN0iqdMPgxi2kx/H7jWcoo2MIrCij1vynx0pO5u/4P3v7wfngz0PZwaqjAvDvshAJULkmY4nHK++RRCJ8Ml4A7pgM3XFCc3FcXEQQdfeZfeo9JnhYDnYn2gfJjLwjX+LtPmlTy2lhF4dYoDWg7YKNUufeA+a+qw09500r00mn8P34GTVhvkrnBlK+adz0r0HZ6qfRmRLNu7JpOGx1Saat+8TeoYJ8O+q7hgYHMVqxgU1XZmUdU6BMg0RVNMU3nTn87o4UmGUn8IX7bdYJ6iFxYIL8xQJQCNXAs66v4i4B6yVfSvOsvArhro6x3+EyPXRLT+p+cnGKiNyMqBmjTlZd2UTujx3ziawE9grxHdoSkin8neyYVrEG1CoIJqC+J6nnIWHk8sm89HHKxhngQqZKiuRYi0TOYdRpKGJH3tJDqpVk66VQr3nO4ciaOCnJlKSk8Gc=
    - secure: cCBqL4SXhRodrrZydl8KarefizmhJMyWRuywleeIaluiIt1OM1S2JpwAg2tWNN3pjrLhXQIOeSYR4Q6R4eaVp9YcmWB6gkiYRdnjWHsaufnviz0Dz2KJrSMDAcMAOFWIQwEmXxI2znAKitBnpjAZOVgOqFKeLfAFhDPlQbM4S++n0rKUL4sMCrrUv+DskPGlreH0LFzHzL3OnzkKBRg73bQ8sXAnwJZKU1VV+xNetBKB4CQwS2jPcfHUZC7OJJB0795uGCC8DiTA+VY+T8frpeH7NhD6gAyEwq5QG5oO7l+sVBFfWWJWX8Zi8qCBq4KAPxv48UHPqc/DlawDyszSC6PpTZv4slvn55gvh5lIrUJp4/29Zcr+0MFj9J+3/j/d9YldZ0lqjPisAM44h2TXQs7jnu4o1YMlZQQ7q2yxyDGG/SMe4P+wJLQgOdWUmSqdAyl3D1krrfVPV3LiEYgDugsYVZP40Ooh45S8t9pc3AIUP+R1nQT3UZ/2Nkx6WDTMzkXVcRYEA3t50oX+QzOpX6oyuThhS+N1sbPH9sQbrhLGjYAIHmF/Vt9JsYeP84ju7rZg3ml6WT0TBVioAPfDbEDQZoCKBz8P+wMqR13jcrAH837sEHttrP8keaZ1An5pvZOG9THeKiIagH/hwlVkcgg9AzPz2YGq96f2C6rnE70=
  matrix:
    - QT_VERSION_MAJOR=5 QT_VERSION_MINOR=13 QT_VERSION_PATCH=1 QT_DOWNLOAD_BRANCH=official_releases QT_TARBALL_NAMING_SCHEME=everywhere CI_BUILD=2 CORE_COUNT=2
    - QT_VERSION_MAJOR=5 QT_VERSION_MINOR=13 QT_VERSION_PATCH=0 QT_DOWNLOAD_BRANCH=official_releases QT_TARBALL_NAMING_SCHEME=everywhere CI_BUILD=2 CORE_COUNT=2
    - QT_VERSION_MAJOR=5 QT_VERSION_MINOR=12 QT_VERSION_PATCH=5 QT_DOWNLOAD_BRANCH=official_releases QT_TARBALL_NAMING_SCHEME=everywhere CI_BUILD=2 CORE_COUNT=2
    - QT_VERSION_MAJOR=5 QT_VERSION_MINOR=12 QT_VERSION_PATCH=4 QT_DOWNLOAD_BRANCH=official_releases QT_TARBALL_NAMING_SCHEME=everywhere CI_BUILD=2 CORE_COUNT=2
    - QT_VERSION_MAJOR=5 QT_VERSION_MINOR=12 QT_VERSION_PATCH=3 QT_DOWNLOAD_BRANCH=official_releases QT_TARBALL_NAMING_SCHEME=everywhere CI_BUILD=2 CORE_COUNT=2
    - QT_VERSION_MAJOR=5 QT_VERSION_MINOR=12 QT_VERSION_PATCH=2 QT_DOWNLOAD_BRANCH=official_releases QT_TARBALL_NAMING_SCHEME=everywhere CI_BUILD=2 CORE_COUNT=2
    - QT_VERSION_MAJOR=5 QT_VERSION_MINOR=12 QT_VERSION_PATCH=1 QT_DOWNLOAD_BRANCH=official_releases QT_TARBALL_NAMING_SCHEME=everywhere CI_BUILD=2 CORE_COUNT=2
    - QT_VERSION_MAJOR=5 QT_VERSION_MINOR=12 QT_VERSION_PATCH=0 QT_DOWNLOAD_BRANCH=official_releases QT_TARBALL_NAMING_SCHEME=everywhere CI_BUILD=2 CORE_COUNT=2
    - QT_VERSION_MAJOR=5 QT_VERSION_MINOR=11 QT_VERSION_PATCH=3 QT_DOWNLOAD_BRANCH=archive QT_TARBALL_NAMING_SCHEME=everywhere CI_BUILD=2 CORE_COUNT=2
    - QT_VERSION_MAJOR=5 QT_VERSION_MINOR=11 QT_VERSION_PATCH=2 QT_DOWNLOAD_BRANCH=archive QT_TARBALL_NAMING_SCHEME=everywhere CI_BUILD=2 CORE_COUNT=2
    - QT_VERSION_MAJOR=5 QT_VERSION_MINOR=11 QT_VERSION_PATCH=1 QT_DOWNLOAD_BRANCH=archive QT_TARBALL_NAMING_SCHEME=everywhere CI_BUILD=2 CORE_COUNT=2
    - QT_VERSION_MAJOR=5 QT_VERSION_MINOR=11 QT_VERSION_PATCH=0 QT_DOWNLOAD_BRANCH=archive QT_TARBALL_NAMING_SCHEME=everywhere CI_BUILD=2 CORE_COUNT=2
    - QT_VERSION_MAJOR=5 QT_VERSION_MINOR=10 QT_VERSION_PATCH=1 QT_DOWNLOAD_BRANCH=archive QT_TARBALL_NAMING_SCHEME=everywhere CI_BUILD=2 CORE_COUNT=2
    - QT_VERSION_MAJOR=5 QT_VERSION_MINOR=10 QT_VERSION_PATCH=0 QT_DOWNLOAD_BRANCH=archive QT_TARBALL_NAMING_SCHEME=everywhere CI_BUILD=2 CORE_COUNT=2
    - QT_VERSION_MAJOR=5 QT_VERSION_MINOR=9 QT_VERSION_PATCH=8 QT_DOWNLOAD_BRANCH=official_releases QT_TARBALL_NAMING_SCHEME=everywhere-opensource CI_BUILD=2 CORE_COUNT=2
    - QT_VERSION_MAJOR=5 QT_VERSION_MINOR=9 QT_VERSION_PATCH=7 QT_DOWNLOAD_BRANCH=official_releases QT_TARBALL_NAMING_SCHEME=everywhere-opensource CI_BUILD=2 CORE_COUNT=2
    - QT_VERSION_MAJOR=5 QT_VERSION_MINOR=9 QT_VERSION_PATCH=6 QT_DOWNLOAD_BRANCH=official_releases QT_TARBALL_NAMING_SCHEME=everywhere-opensource CI_BUILD=2 CORE_COUNT=2
    - QT_VERSION_MAJOR=5 QT_VERSION_MINOR=9 QT_VERSION_PATCH=5 QT_DOWNLOAD_BRANCH=official_releases QT_TARBALL_NAMING_SCHEME=everywhere-opensource CI_BUILD=2 CORE_COUNT=2
    - QT_VERSION_MAJOR=5 QT_VERSION_MINOR=9 QT_VERSION_PATCH=4 QT_DOWNLOAD_BRANCH=official_releases QT_TARBALL_NAMING_SCHEME=everywhere-opensource CI_BUILD=2 CORE_COUNT=2
    - QT_VERSION_MAJOR=5 QT_VERSION_MINOR=9 QT_VERSION_PATCH=3 QT_DOWNLOAD_BRANCH=official_releases QT_TARBALL_NAMING_SCHEME=everywhere-opensource CI_BUILD=2 CORE_COUNT=2
    - QT_VERSION_MAJOR=5 QT_VERSION_MINOR=9 QT_VERSION_PATCH=2 QT_DOWNLOAD_BRANCH=official_releases QT_TARBALL_NAMING_SCHEME=everywhere-opensource CI_BUILD=2 CORE_COUNT=2
    - QT_VERSION_MAJOR=5 QT_VERSION_MINOR=9 QT_VERSION_PATCH=1 QT_DOWNLOAD_BRANCH=official_releases QT_TARBALL_NAMING_SCHEME=everywhere-opensource CI_BUILD=2 CORE_COUNT=2
    - QT_VERSION_MAJOR=5 QT_VERSION_MINOR=9 QT_VERSION_PATCH=0 QT_DOWNLOAD_BRANCH=official_releases QT_TARBALL_NAMING_SCHEME=everywhere-opensource CI_BUILD=2 CORE_COUNT=2
    - QT_VERSION_MAJOR=5 QT_VERSION_MINOR=6 QT_VERSION_PATCH=3 QT_DOWNLOAD_BRANCH=archive QT_TARBALL_NAMING_SCHEME=everywhere-opensource CI_BUILD=2 CORE_COUNT=2
    - QT_VERSION_MAJOR=5 QT_VERSION_MINOR=6 QT_VERSION_PATCH=2 QT_DOWNLOAD_BRANCH=archive QT_TARBALL_NAMING_SCHEME=everywhere-opensource CI_BUILD=2 CORE_COUNT=2
    - QT_VERSION_MAJOR=5 QT_VERSION_MINOR=6 QT_VERSION_PATCH=1-1 QT_DOWNLOAD_BRANCH=archive QT_TARBALL_NAMING_SCHEME=everywhere-opensource CI_BUILD=2 CORE_COUNT=2
    - QT_VERSION_MAJOR=5 QT_VERSION_MINOR=6 QT_VERSION_PATCH=0 QT_DOWNLOAD_BRANCH=archive QT_TARBALL_NAMING_SCHEME=everywhere-opensource CI_BUILD=2 CORE_COUNT=1
stages:
  - test
  - merge
script:
  - 'if [ "$TRAVIS_PULL_REQUEST" = "false" ]; then echo $DOCKER_PASSWORD | docker login -u $DOCKER_USERNAME --password-stdin  || travis_terminate 1; fi'
  - docker pull darkmattercoder/qt-build:$QT_VERSION_MAJOR.$QT_VERSION_MINOR.$QT_VERSION_PATCH || true
  - docker pull darkmattercoder/qt-build:builder-$QT_VERSION_MAJOR.$QT_VERSION_MINOR.$QT_VERSION_PATCH || true
  - docker pull darkmattercoder/qt-build:base-$QT_VERSION_MAJOR.$QT_VERSION_MINOR.$QT_VERSION_PATCH || true
  - travis_wait 180 docker build --pull --cache-from darkmattercoder/qt-build:base-$QT_VERSION_MAJOR.$QT_VERSION_MINOR.$QT_VERSION_PATCH --build-arg QT_VERSION_MAJOR=$QT_VERSION_MAJOR --build-arg QT_VERSION_MINOR=$QT_VERSION_MINOR --build-arg QT_VERSION_PATCH=$QT_VERSION_PATCH --build-arg QT_DOWNLOAD_BRANCH=$QT_DOWNLOAD_BRANCH --build-arg QT_TARBALL_NAMING_SCHEME=$QT_TARBALL_NAMING_SCHEME --build-arg CI_BUILD=$CI_BUILD --build-arg CORE_COUNT=$CORE_COUNT --target=base -t darkmattercoder/qt-build:base-$QT_VERSION_MAJOR.$QT_VERSION_MINOR.$QT_VERSION_PATCH . || travis_terminate 1;
  - 'if [ "$TRAVIS_PULL_REQUEST" = "false" ]; then docker push darkmattercoder/qt-build:base-$QT_VERSION_MAJOR.$QT_VERSION_MINOR.$QT_VERSION_PATCH || travis_terminate 1; fi'
  - travis_wait 180 docker build --pull --cache-from darkmattercoder/qt-build:builder-$QT_VERSION_MAJOR.$QT_VERSION_MINOR.$QT_VERSION_PATCH --build-arg QT_VERSION_MAJOR=$QT_VERSION_MAJOR --build-arg QT_VERSION_MINOR=$QT_VERSION_MINOR --build-arg QT_VERSION_PATCH=$QT_VERSION_PATCH --build-arg QT_DOWNLOAD_BRANCH=$QT_DOWNLOAD_BRANCH --build-arg QT_TARBALL_NAMING_SCHEME=$QT_TARBALL_NAMING_SCHEME --build-arg CI_BUILD=$CI_BUILD --build-arg CORE_COUNT=$CORE_COUNT --target=builder -t darkmattercoder/qt-build:builder-$QT_VERSION_MAJOR.$QT_VERSION_MINOR.$QT_VERSION_PATCH . || travis_terminate 1;
  - travis_wait 180 docker build --pull --cache-from darkmattercoder/qt-build:builder-$QT_VERSION_MAJOR.$QT_VERSION_MINOR.$QT_VERSION_PATCH --build-arg QT_VERSION_MAJOR=$QT_VERSION_MAJOR --build-arg QT_VERSION_MINOR=$QT_VERSION_MINOR --build-arg QT_VERSION_PATCH=$QT_VERSION_PATCH --build-arg QT_DOWNLOAD_BRANCH=$QT_DOWNLOAD_BRANCH --build-arg QT_TARBALL_NAMING_SCHEME=$QT_TARBALL_NAMING_SCHEME --build-arg CI_BUILD=$CI_BUILD --build-arg CORE_COUNT=$CORE_COUNT --target=qt -t darkmattercoder/qt-build:$QT_VERSION_MAJOR.$QT_VERSION_MINOR.$QT_VERSION_PATCH . || travis_terminate 1;
  - tests/generate_tests.py || travis_terminate 1;
  - docker run --rm -u $UID -v $PWD/tests:/var/build darkmattercoder/qt-build:$QT_VERSION_MAJOR.$QT_VERSION_MINOR.$QT_VERSION_PATCH build || travis_terminate 1;
  - docker run --rm -u $UID -v $PWD/tests:/var/build darkmattercoder/qt-build:$QT_VERSION_MAJOR.$QT_VERSION_MINOR.$QT_VERSION_PATCH /var/build/run-tests.sh /var/build/build || travis_terminate 1;
  - 'if [ "$TRAVIS_PULL_REQUEST" = "false" ]; then docker push darkmattercoder/qt-build:$QT_VERSION_MAJOR.$QT_VERSION_MINOR.$QT_VERSION_PATCH || travis_terminate 1; fi'
  - 'if [ "$TRAVIS_PULL_REQUEST" = "false" ]; then docker push darkmattercoder/qt-build:builder-$QT_VERSION_MAJOR.$QT_VERSION_MINOR.$QT_VERSION_PATCH || travis_terminate 1; fi'
  - python ci/tag_image.py darkmattercoder/qt-build:$QT_VERSION_MAJOR.$QT_VERSION_MINOR.$QT_VERSION_PATCH || travis_terminate 1;
  - 'if [ "$TRAVIS_PULL_REQUEST" = "false" ]; then python ci/push_images.py darkmattercoder/qt-build:$QT_VERSION_MAJOR.$QT_VERSION_MINOR.$QT_VERSION_PATCH; fi'
jobs:
  include:
    - stage: merge
      if: type != pull_request
      script:
        - export GIT_COMMITTER_EMAIL="travis-ci-bot@jochenbauer.net"
        - export GIT_COMMITTER_NAME="Travis CI bot"
        - git config --add remote.origin.fetch +refs/heads/*:refs/remotes/origin/* || exit
        - git fetch --all || exit
        - git checkout master || exit
        - git rebase deploy || exit
        - git push https://${GITHUB_ACCESS_TOKEN}@github.com/darkmattercoder/qt-build.git
